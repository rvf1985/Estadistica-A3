---
title: 'Estad√≠stica Avanzada: A3 - Modelizaci√≥n predictiva'
author: "Autor: Ra√∫l Vicente Ferrer"
date: "Diciembre 2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL", "en_US.UTF-8")
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# https://cran.r-project.org/web/packages/ggplot2/index.html
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
# https://cran.r-project.org/web/packages/dplyr/index.html
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
# https://cran.r-project.org/web/packages/dplyr/index.html
if (!require('knitr')) install.packages('knitr'); library('knitr')
# https://cran.r-project.org/web/packages/corrplot/index.html
if (!require('corrplot')) install.packages('corrplot'); library('corrplot')
# https://cran.r-project.org/web/packages/faraway/index.html
if (!require('faraway')) install.packages('faraway'); library('faraway')
```

******
# Regresi√≥n lineal
******

Carga del dataset:

```{r}
df <- read.csv("./dat_Air.csv", header=TRUE) 
```

```{r}
str(df)
summary(df)
```

## Estudio de correlaci√≥n lineal

* Matriz de correlaci√≥n:

```{r}
# Buscamos valores nulos
sapply(df, function(x) sum(is.na(x)))
# Eliminamos los valores nulos
df <- na.omit(df)
```

```{r}
# calculamos y representamos la matriz de correlaci√≥n
datos_corr <- df[, c(11, 9, 12, 19, 20, 22, 18, 17)]
M <- cor(datos_corr, method = "pearson")
corrplot(M, method = "number")
```

* ¬øCual de los contaminantes atmosf√©ricos citados anteriormente, tienen una mayor relaci√≥n lineal con la RS? Interpretar las relaciones de dicho contaminante con la RS y tambi√©n con el resto de variables meteorol√≥gicas.
El contaminante atmosf√©rico que tiene una mayor relaci√≥n lineal con RS es O3 ya que, como se puede observar en la matriz de correlaci√≥n, su coeficiente es el mayor (en valor absoluto). La relaci√≥n que tienen es en sentido directo y de magnitud d√©bil.
Tmp: relaci√≥n en sentido directo y de magnitud d√©bil.
HR: relaci√≥n en sentido inverso y de magnitud d√©bil.
Vel: relaci√≥n en sentido directo y de magnitud moderada.
Dir_Aire: relaci√≥n en sentido inverso y de magnitud d√©bil.

* Se toma la media diaria de cada una de las variables del apartado a) y posteriormente se estudia de nuevo la relaci√≥n pedida en dicho apartado.
¬øExiste alguna diferencia en la relaci√≥n entre las nuevas variables construidas con los valores medios diarios, con respecto a los resultados obtenidos anteriormente?

Matriz de correlaci√≥n de las nuevas variables:

```{r}
# Media diar√≠a de cada variable
byday = aggregate(df[,c("O3", "NO2", "PM10", "Tmp", "HR", "RS", "Vel", "Dir_Aire")], by = list(df$Fecha), mean)
# calculamos y representamos la matriz de correlaci√≥n
datos_corr <- byday[, c(2:9)]
M_byday <- cor(datos_corr, method = "pearson")
corrplot(M_byday, method = "number")
```

Diferencias entre las dos matrices:

```{r}
M_dif <- M-M_byday
corrplot(M_dif, method = "number")
```

Se pueden observar algunas diferencias significativas.

## Modelo de regresi√≥n lineal

* Estimar por m√≠nimos cuadrados ordinarios un modelo lineal que explique la variable O3 en funci√≥n de
la radiaci√≥n solar (RS). Se evaluar√° la bondad del ajuste, a partir del coeficiente de determinaci√≥n.

```{r}
Model.1.2.a <- lm(O3~RS, data=df)
summary(Model.1.2.a)
```

El coeficiente de determinaci√≥n es 0.1381, por lo tanto, la calidad del ajuste es mala. Como era de esperar, ya que la correlaci√≥n entre ambas variables es d√©bil.

* Modelo de regresi√≥n lineal, tomando como variable dependiente (O3) y la variable
explicativa PM10_cat

Creaci√≥n de la variable PM10_cat:

```{r}
PM10_cat <- cut(df$PM10, breaks = c(0, 40, 60, 120, 160, 724),
                labels = c("Muy buena", "Buena", "Mejorable", "Mala", "Muy mala"),
                right = FALSE)
df_1.2 <- data.frame(df, PM10_cat)
```

Modelo de regresi√≥n lineal

```{r}
Model.1.2.b<- lm(O3~PM10_cat, data=df)
summary(Model.1.2.b)
```

El coeficiente de determinaci√≥n es 0.445, por lo tanto, la calidad del ajuste es baja, a pesar de que la relaci√≥n entre las variables es moderada.

## Modelo de regresi√≥n lineal m√∫ltiple

Explicar el nivel de ozono en funci√≥n de la radiaci√≥n solar (RS),concentraci√≥n de di√≥xido de nitr√≥geno (NO2), temperatura (Tmp) y direcci√≥n del aire (Dir_Aire).

* Primero, se a√±adir√° al modelo del apartado a), la variable explicativa (Dir_Aire).¬øEl modelo ha mejorado?

```{r}
Model.1.3.a <- lm(O3~RS+Dir_Aire, data=df)
summary(Model.1.3.a)
```

El coeficiente de determinaci√≥n es 0.2444, por lo tanto, la calidad del ajuste ha aumentado, pero sigue siendo mala.

* Posteriormente se a√±ade al modelo anterior la variable (NO2). ¬øExiste una mejora del modelo?

```{r}
Model.1.3.b <- lm(O3~RS+Dir_Aire+NO2, data=df)
summary(Model.1.3.b)
```

El coeficiente de determinaci√≥n es 0.581, por lo tanto, la calidad del ajuste ha aumentado y es moderada.

* Se toma la variable (Tmp) y se a√±ade al modelo anterior. Se pide comprobar la presencia o no de colinealidad entre las variables (RS) y (Tmp). Seg√∫n la conclusi√≥n obtenida, discutir si ser√≠a indicado o no a√±adir la variable (Tmp) al modelo. De ser afirmativa la respuesta, construye el modelo e interpreta el resultado.

```{r}
# Coeficiente de correlaci√≥n entre las variables
cor(x = df$RS, y = df$Tmp, method = "pearson")
# comparaci√≥n de las estimaciones de modelos
Model.1.3.c <- lm(O3~RS+Dir_Aire+NO2+Tmp, data=df)
model.RS <- lm(O3~RS, data=df)
model.Tmp<- lm(O3~Tmp, data=df)
summary(Model.1.3.c)
summary(model.RS)
summary(model.Tmp)
```

```{r}
# C√°culo de FIV
vif(Model.1.3.c)
# Se compara con 1/(1-R2)
1/(1-summary(Model.1.3.c)$r.squared)
```

Por un lado el coeficiente de correlaci√≥n entre ambas variables es de 0.4, por lo que la relaci√≥n lineal entre ambas variables es baja. Por otro lado, si comparamos el modelo global, con cada uno de los modelos simples, los coeficientes estimados para RS y Tmp difieren de los estimados con la regresi√≥n m√∫ltiple.Esto puede ser indicativo de un problema de colinealidad.
Estudiando la inflaci√≥n de la varianza y covarianza de las estimaciones, se calcula el FIV(factor de inflaci√≥n de la varianza), 
para RS FIV = 1.242683 y para Tmp FIV = 1.369280 resultan menores que su equivalente en el modelo global, 1/(1‚àíR2) = 2.388696. A la vista de los resultados, se encuentran indicios de multicolinealidad entre los regresores ‚ÄôRS‚Äô y ‚ÄôTmp‚Äô.
Por lo tanto, no ser√≠a indicado a√±adir la variable Tmp al modelo.

## Diagnosis del modelo

* Para la diagnosis se escoge el modelo constru√≠do en el apartado b) y se piden dos gr√°ficos: uno con los valores ajustados frente a los residuos (que nos permitir√° ver si la varianza es constante) y el gr√°fico cuantil-cuantil que compara los residuos del modelo con los valores de una variable que se distribuye normalmente(QQ plot). Interpretar los resultados.

```{r}
residuos <- rstandard(Model.1.3.b)
valor.ajustados <- fitted(Model.1.3.b)
plot(valor.ajustados, residuos)
```

```{r}
qqnorm(residuos)
```

A la vista del gr√°fico se observa un patr√≥n de dispersi√≥n irregular. Es decir no es un patr√≥n aleatorio de los residuos alrededor de cero, muestra cierto tipo de estructura. Esto indica que no se cumple el supuesto de varianza constante en los errores del modelo.
Por otro lado el Q_Q plot, muestra que los datos se ajustan bien a una normal.

## Predicci√≥n del modelo

* Seg√∫n el modelo del apartado c), calcular la concentraci√≥n de O3, si se tienen valores de RS de 180, NO2 de 15, Dir_Aire de 250 grados y Tmp de 20 grados cent√≠grados.

```{r}
newdata = data.frame(RS=180, NO2=15, Dir_Aire=250, Tmp=20)
predict(Model.1.3.c, newdata)
```

Se obtiene un valor de 37.10378 ùúáùëî/ùëö3.

******
# Regresi√≥n log√≠stica
******

Estudio de la concentraci√≥n de O3 del aire de una determinada ciudad.

Primera codificaci√≥n de la variable icO3:

```{r}
df <- read.csv("./dat_Air.csv", header=TRUE)
icO3 <- cut(df$O3, breaks = c(0, 80, 100),
                labels = c("buena", "mejorable"),
                right = FALSE)
df_2a <- data.frame(df, icO3)
```

Segunda codificaci√≥n de la variable icO3:

```{r}
df_2b <- df_2a
df_2b$icO3 <- as.numeric(df_2b$icO3)
df_2b$icO3[df_2b$icO3 == "1"] = 0
df_2b$icO3[df_2b$icO3 == "2"] = 1
df_2b$icO3[is.na(df_2b$icO3)] = 1
df_2b$icO3 <- as.factor(df_2b$icO3)
summary(df_2b$icO3)
```

## Estudio de relaciones entre variables. An√°lisis crudo de posibles factores de riesgo

* Se visualiza la relaci√≥n entre icO3 y las variables independientes: RS, Vel y HR. Para ello se recodificaran las variables RS y Vel, dejando la variable cuantitativa HR, tal como est√° en la base de datos. Para comprobar si existe asociaci√≥n entre las variable dependiente y cada una de las variables explicativas, se aplicar√° el test Chi-cuadrado de Pearson. Un resultado significativo nos dir√° que existe asociaci√≥n.

Codificaci√≥n de las variables RS_cat2 y Vel_cat2:

```{r}
RS_cat2 <- cut(df_2b$RS, breaks = c(0, 100, 700),
                labels = c("normal_baja", "normal_alta"),
                right = FALSE)
Vel_cat2 <- cut(df_2b$Vel, breaks = c(0, 3, 10),
                labels = c("flojo", "moderado"),
                right = FALSE)
df_2b <- data.frame(df_2b, RS_cat2, Vel_cat2)
```

Visualizaci√≥n y test Chi-cuadrado de Pearson de la relaci√≥n icO3 - RS_cat2:

```{r}
tr<-table(df_2b$icO3,df_2b$RS_cat2)
tr
```

```{r}
tr_rel<-prop.table(tr,1)
tr_rel
```

```{r}
tr_rel_col<-prop.table(tr,2)
tr_rel_col
```

```{r}
barplot(tr_rel_col)
```

```{r}
chi.test.tr<-chisq.test(tr)
print(chi.test.tr)
```

Visualizaci√≥n y test Chi-cuadrado de Pearson de la relaci√≥n icO3 - Vel_cat2:

```{r}
tv<-table(df_2b$icO3,df_2b$Vel_cat2)
tv
```

```{r}
tv_rel<-prop.table(tv,1)
tv_rel
```

```{r}
tv_rel_col<-prop.table(tv,2)
tv_rel_col
```

```{r}
barplot(tv_rel_col)
```

```{r}
chi.test.tv<-chisq.test(tv)
print(chi.test.tv)
```

Visualizaci√≥n y test Chi-cuadrado de Pearson de la relaci√≥n icO3 - HR:

```{r}
th<-table(df_2b$icO3,df_2b$HR)
th
```

```{r}
th_rel<-prop.table(th,1)
th_rel
```

```{r}
th_rel_col<-prop.table(th,2)
th_rel_col
```

```{r}
barplot(th_rel_col)
```

```{r warning=FALSE}
chi.test.th<-chisq.test(th)
print(chi.test.th)
```

Como se puede ver en los test Chi-cuadrado de Pearson, el p_value es pr√°cticamente 0 en los tres casos. As√≠ que rechazamos la hip√≥tesis nula de independencia de variables. Se acepta que existe una relaci√≥n significativa entre icO3 y cada una de las otras tres variables.

* C√°lculo de las OR (Odds-Ratio)

icO3 - RS_cat2:

```{r}
# C√°culo de las OR
tr_M<- addmargins(tr, FUN = list(Total = sum), quiet = TRUE)
tr_M
p1_tr=((tr_M[2,2]/tr_M[3,2])/(1-(tr_M[2,2]/tr_M[3,2])))
p2_tr=((tr_M[2,1]/tr_M[3,1])/(1-(tr_M[2,1]/tr_M[3,1])))
OR_tr=p1_tr/p2_tr
OR_tr
```

OR de 3.659214, por lo que se interpreta que las odds de que el √≠ndice de calidad del aire basado en O3 sea bueno es 3.659214 veces mayor en valores de Radiaci√≥n Solar normal_baja que para normal_alta.

icO3 - RS_Vel2:

```{r}
# C√°culo de las OR
tv_M<- addmargins(tv, FUN = list(Total = sum), quiet = TRUE)
tv_M
p1_tv=((tv_M[2,2]/tv_M[3,2])/(1-(tv_M[2,2]/tv_M[3,2])))
p2_tv=((tv_M[2,1]/tv_M[3,1])/(1-(tv_M[2,1]/tv_M[3,1])))
OR_tv=p1_tv/p2_tv
OR_tv
```

OR de 2.111013, por lo que se interpreta que las odds de que el √≠ndice de calidad del aire basado en O3 sea bueno es 2.111013 veces mayor en valores de Velocidad del viento floja que para moderada.

icO3 - HR:

No se puede seguir el mismo procedimiento para calcular la OR que para las otras dos variables, ya que es una variable continua. Se deber√≠a construir un modelo de regresi√≥n log√≠stica.

## Modelo de regresi√≥n log√≠stica

* Estimad el modelo de regresi√≥n log√≠stica tomando como variable dependiente icO3 y variable explicativa RS_cat2. Calculad la OR a partir de los resultados del modelo y su intervalo de confianza. ¬øSe puede considerar que la radiaci√≥n solar es un factor de riesgo?

```{r}
logit_model_1 <- glm(formula = icO3~RS_cat2, data=df_2b, family=binomial)
summary(logit_model_1)
```

```{r}
exp(cbind(coef(logit_model_1),confint(logit_model_1)))
```

La radiaci√≥n solar es un factor de riesgo ya que OR es mayor que 1, en concreto 3.65921382.

* Se crea un nuevo modelo con la misma variable dependiente y se a√±ade al apartado a) la variable TMP. Interpretar si nos encontramos o no ante una posible variable de confusi√≥n.

```{r}
logit_model_2 <- glm(formula = icO3~RS_cat2+Tmp, data=df_2b, family=binomial)
summary(logit_model_2)
```

```{r}
exp(coefficients(logit_model_2))
```

La proximidad de los valores entre la OR estimada de RS_cat2 con el primer modelo (3.65921382) y el modelo ajustado (2.895915576), podr√≠a descartar que Tmp sea una variable de confusi√≥n.

* Se a√±ade al modelo del apartado a) la variable HR. Estudiar la existencia o no de interacci√≥n entre las variables explicativas RS_cat2 y HR. Interpretar.

```{r}
logit_model_3=glm(formula=icO3~RS_cat2+HR+RS_cat2:HR, data=df_2b, family=binomial(link=logit))
summary(logit_model_3)
```

Se observa que el estimador de interacci√≥n RS_cat2:HR es estad√≠sticamente significativo.

* Se crea un nuevo modelo con las variables explicativas RS_cat2 y Dir_Aire. ¬øExiste una mejora del modelo?

```{r}
logit_model_4=glm(formula=icO3~RS_cat2+Dir_Aire, data=df_2b, family=binomial)
summary(logit_model_4)
```

El indicador AIC= 2089.4 es menor que en los otros modelos, por lo que existe una mejora en el ajuste, aunque no muy grande.


## Predicci√≥n

* Diagrama de caja de la distribuci√≥n de la variable 'UltCost':

```{r}

```

## Bondad del ajuste

* Diagrama de caja de la distribuci√≥n de la variable 'UltCost':

```{r}

```

## Curva ROC

* Diagrama de caja de la distribuci√≥n de la variable 'UltCost':

```{r}

```

******
# Conclusiones del an√°lisis
******

* Diagrama de caja de la distribuci√≥n de la variable 'UltCost':

******
# Bibliograf√≠a
******

* Apuntes y recursos de la asignatura.